---
editor_options:
  chunk_output_type: console
---

# INTERNAL

## Avoid `R CMD check` notes about undefined global objects used in magrittr pipes

cf. <https://github.com/tidyverse/magrittr/issues/29#issuecomment-74313262>

```{r}
utils::globalVariables(names = ".")
```

# Purl `Rmd/*.Rmd` to `R/*-GEN.R`

The basic workflow is heavily inspired by a pertinent makefile from Yihui Xie found [here](https://yihui.org/rlp/#from-rmd-to-r). Not least because I'm a
complete noob regarding [makefile syntax](https://en.wikipedia.org/wiki/Makefile), I decided to write the relevant pieces in R.

```{r}
#' Purl `Rmd/*.Rmd` to `R/*-GEN.R`
#'
#' This function strives to provide a standardized way to convert all `.Rmd` files in the `Rmd/` subdirectory to bare `.R` files in the `R/` subdirectory using
#' [knitr::purl()]. It is mainly intended for authoring R packages in the [R Markdown file format](https://rmarkdown.rstudio.com/).
#'
#' The generated `.R` files will be named the same as the `.Rmd` files plus the suffix `-GEN` to indicate the file was auto-generated. So the file
#' `Rmd/foo.Rmd` for example will be converted to `R/foo-GEN.R`.
#'
#' The R Markdown file format allows you to intermingle code with related prose in [Markdown syntax](https://bookdown.org/yihui/rmarkdown/markdown-syntax.html)
#' optimized for human readability. This facilitates (best) practices which are commonly referred to as
#' [_literate programming_](https://en.wikipedia.org/wiki/Literate_programming).
#' 
#' In practice, the main advantage of writing R code in R Markdown is that you don't have to rely on
#' [`#` comments](https://cran.r-project.org/doc/manuals/r-release/R-lang.html#Comments) to explain, annotate or otherwise elaborate on your code. It also
#' allows you to easily compile your source code to beautifully looking HTML, PDF etc. files using [rmarkdown::render()].
#'
#' `r pkgsnip::md_snip("rstudio_addin_hint")`
#'
#' @param path The path to the root of the package directory.
#'
#' @export
purl_rmd <- function(path = ".") {
  
  rmd_dir <- fs::path_abs(path, "Rmd/")
  
  if (fs::dir_exists(rmd_dir)) {
    
    rmd_files <- fs::dir_ls(path = rmd_dir,
                            regexp = "Rmd/[^/]+\\.[Rr]md")
    
    if (length(rmd_files)) {
      
      pal::cli_process_expr(msg = "Purling {.file Rmd/*.Rmd} to {.file R/*-GEN.R}",
                            expr = {
        
        r_dir <- fs::path(path, "R/")
        if (!fs::dir_exists(r_dir)) fs::dir_create(r_dir)
        
        rmd_files %>% purrr::walk(process_rmd)
      })
      
    } else {
      cli::cli_alert_warning(text = "{.file {path}} does not appear to be an Rmd package directory. Nothing done.")
    }
  } else {
    cli::cli_alert_warning(text = "{.file {path}/Rmd/} does not exist. Nothing done.")
  }
}

# helper function purling a single file `Rmd/*.Rmd` to `R/*-GEN.R`
process_rmd <- function(rmd) {
  
  output <- sub(x = rmd,
                pattern = "Rmd/([^/]+)\\.[Rr]md$",
                replacement = "R/\\1-GEN.R")
  
  knitr::purl(input = rmd,
              output = output,
              quiet = TRUE,
              documentation = 0L)
  
  # add reminder header lines to generated R files
  result <-
    rmd %>%
    fs::path_rel(start = fs::path_dir(fs::path_dir(.))) %>%
    paste0("# DO NOT EDIT THIS FILE BY HAND! Instead edit the R Markdown source file `", ., "` and run `pkgpurl::purl_rmd()`.\n",
           "# See `README.md#r-markdown-format` for more information on the literate programming approach used applying the R Markdown format.\n\n",
           brio::read_file(path = output))
  
  brio::write_file(text = result,
                   path = output)
}
```

# Lint R Markdown package

TODO:

-   [ ] For some reason, `lint_rmd()` doesn't properly work when launched from the registered RStudio add-in (the `Markers` tab doesn't open). It works fine
    though when executed from the console. -\> Investigate!

**Notes:**

-   For some reason, `lintr::lint_dir(".")` excludes all of the generated `-GEN.R` files out of the box. Maybe because their first line starts with
    `# DO NOT EDIT THIS FILE BY HAND! ...`?

    If in the future they won't be excluded anymore for some reason, a sensible way to run lintr on the whole package dir seems:

    ``` {.r}
    lintr::lint_dir(path = ".",
                    pattern = "\\.[Rr]([Mm][Dd])?$",
                    exclusions = list.files(path = "R",
                                            recursive = TRUE,
                                            full.names = TRUE,
                                            pattern = "-GEN\\.R$"))
    ```

```{r}
#' Lint R Markdown package
#'
#' This is a convenience wrapper around [lintr::lint_dir()] which is tailored to a typical R Markdown package. To use this function, the
#' [lintr](https://github.com/jimhester/lintr/#readme) package is required.
#'
#' To avoid unnecessary noise, all the the generated `R/*-GEN.R` files as well as R Markdown vignettes under `vignettes/*.Rmd` are excluded from linting.
#'
#' `r pkgsnip::md_snip("rstudio_addin_hint")`
#'
#' @param exclude_vignettes Whether to exclude all `.Rmd` files under `vignettes/`. A logical scalar.
#' @inheritParams purl_rmd
#'
#' @export
lint_rmd <- function(path = ".",
                     exclude_vignettes = TRUE) {
  
  pal::assert_pkg("lintr")
  
  lintr::lint_dir(path = checkmate::assert_directory(path,
                                                     access = "r"),
                  pattern = "\\.[Rr]([Mm][Dd])?$",
                  exclusions = list(c(list.files(path = "R",
                                                 recursive = TRUE,
                                                 full.names = TRUE,
                                                 pattern = "-GEN\\.R$"),
                                      list.files(path = "vignettes",
                                                 recursive = TRUE,
                                                 full.names = TRUE,
                                                 pattern = "\\.Rmd$")[!checkmate::assert_flag(exclude_vignettes)])))
}
```
